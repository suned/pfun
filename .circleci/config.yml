defaults: &defaults
  working_directory: ~/pfun
  docker:
    - image: circleci/python:3.7.5

version: 2
jobs:
  test:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ checksum "poetry.lock" }}
      - run:
          name: Install poetry
          command: POETRY_VERSION=1.0.9 curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python
      - run:
          name: Configure poetry
          command: poetry config settings.virtualenvs.in-project true
      - run:
          name: Install dependencies
          command: poetry install
      - run:
          name: Test
          command: poetry run tox
      - save_cache:
          key: dependency-cache-{{ checksum "poetry.lock" }}
          paths:
            - .venv
            - .tox
      - run:
          name: Lint
          command: poetry run flake8 pfun tests examples
      - run:
          name: Typecheck
          command: poetry run mypy pfun examples
  release:
    <<: *defaults
    steps:
      - checkout
      - run:
            name: Install depenencies
            command: poetry install
      - run:
            name: Check version
            command: poetry run python scripts/check_version.py pyproject.toml $CIRCLE_TAG
      - run:
            name: Build
            command: poetry build
      - run:
            name: Release
            command: poetry publish --username $PYPI_USERNAME --password $PYPI_PASSWORD

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - test:
          filters:
            tags:
              only: /.*/
      - release:
          requires:
            - test
          filters:
            tags:
              only: /[0-9]+(\.[0-9]+)*/
            branches:
              ignore: /.*/
